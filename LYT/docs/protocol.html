<!DOCTYPE html>  <html> <head>   <title>protocol.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="cache.html">                 cache.coffee               </a>                                           <a class="source" href="config.html">                 config.coffee               </a>                                           <a class="source" href="daisy.html">                 daisy.coffee               </a>                                           <a class="source" href="nccfile.html">                 nccfile.coffee               </a>                                           <a class="source" href="protocol.html">                 protocol.coffee               </a>                                           <a class="source" href="rpc.html">                 rpc.coffee               </a>                                           <a class="source" href="service.html">                 service.coffee               </a>                                           <a class="source" href="utils.html">                 utils.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               protocol.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>This module models the Daisy Online Protocol</p>

<p>An RPC (Remote Procedure Call) is declared as a nested object in the <code>protocol</code>-object
An RPC object can have the following members:</p>

<ul>
<li><code>request</code>   - a function that returns the SOAP data to be sent as the request body</li>
<li><code>receive</code>   - a function that parses the response from the server, if the request is successful</li>
<li><code>complete</code>  - a function that will be called when the request completes</li>
<li><code>error</code>     - an error-handling function</li>
</ul>

<p>All these members are optional</p>

<p>FIXME: ... moar docs!</p>

<p>An RPC is called by passing its name to the rpc function, plus whatever arguments are needed:</p>

<pre><code>rpc "getStuffFromServer", foo, bar
</code></pre>

<p>If an RPC named "getStuffFromServer" doens't exist, the rpc function will throw an exception.
If it does exist, the rpc function will look for the request member. If such a member is found, and is a function
it will be passed the arguments (<code>foo</code> &amp; <code>bar</code> in this example), and its return value (if any) will be used to
generate the SOAP request body.
If no request function is found, or it returns a non-object value, the request body will simply be an empty
XML tag, mirroring the name of the RPC</p>

<h2>RPC example</h2>

<pre><code># The RPC's name, i.e. the name of the action to call on the server
actionName: 

  # The optional request function, with whatever
  # arguments it requires (if any)
  request: (args...) -&gt; 
    # The request function may optionally return
    # an object. If it does, that object is then
    # turned into XML and sent as the SOAP body
    key1: value1

  # The optional receive function which will
  # be passed the data returned by the server
  receive: ($xml, data, status, xhr) -&gt; ...

  # The optional complete callback
  complete: (xhr, status) -&gt; ...

  # The optional error handler
  error: (xhr, status, error) -&gt; ...
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre><span class="vi">@protocol =</span>
  </pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <hr />             </td>             <td class="code">               <div class="highlight"><pre>  
  <span class="nv">logOn:</span>
    <span class="nv">request: </span><span class="nf">(username, password) -&gt;</span>
      <span class="nv">username: </span><span class="nx">username</span>
      <span class="nv">password: </span><span class="nx">password</span>
    
    <span class="nv">receive: </span><span class="nf">($xml, data) -&gt;</span>
      <span class="k">if</span> <span class="nx">$xml</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;logOnResult&quot;</span><span class="p">).</span><span class="nx">text</span><span class="p">()</span> <span class="o">is</span> <span class="s2">&quot;true&quot;</span>
        <span class="nx">rpc</span> <span class="s2">&quot;getServiceAttributes&quot;</span>
      <span class="k">else</span>
        <span class="nx">eventSystemForceLogin</span> <span class="s2">&quot;Du har indtastet et forkert brugernavn eller password&quot;</span> <span class="c1"># FIXME: Not a great function name</span>
  
  
  <span class="nv">logOff:</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>FIXME: Can log off fail? If so, how should it be handled?</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">receive: </span><span class="nf">($xml, data) -&gt;</span>
      <span class="nx">eventSystemLogedOff</span> <span class="nx">$xml</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;logOffResult&quot;</span><span class="p">)</span><span class="o">?</span><span class="p">.</span><span class="nx">text</span><span class="p">()</span> <span class="o">or</span> <span class="s2">&quot;&quot;</span> <span class="c1"># FIXME: Not a great function name - and it&#39;s spelled wrong</span>
  
  
  <span class="nv">getServiceAttributes:</span>
    <span class="nv">receive: </span><span class="nf">($xml, data) -&gt;</span>
      <span class="nx">$xml</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;supportedOptionalOperations &gt; operation&quot;</span><span class="p">).</span><span class="nx">each</span> <span class="o">-&gt;</span>
        <span class="nv">op = </span><span class="nx">jQuery</span> <span class="k">this</span>
        <span class="nv">DODP.service.announcements = </span><span class="p">(</span><span class="nx">op</span><span class="p">.</span><span class="nx">text</span><span class="p">()</span> <span class="o">is</span> <span class="s2">&quot;SERVICE_ANNOUNCEMENTS&quot;</span><span class="p">)</span>
      <span class="nx">rpc</span> <span class="s2">&quot;setReadingSystemAttributes&quot;</span>
  
  
  <span class="nv">setReadingSystemAttributes:</span>
    <span class="nv">request: </span><span class="o">-&gt;</span>
      <span class="nv">readingSystemAttributes:</span>
        <span class="nv">manufacturer: </span><span class="s2">&quot;NOTA&quot;</span>
        <span class="nv">model: </span><span class="s2">&quot;LYT&quot;</span>
        <span class="nv">serialNumber: </span><span class="s2">&quot;1&quot;</span>
        <span class="nv">version: </span><span class="s2">&quot;1&quot;</span>
        <span class="nv">config: </span><span class="kc">null</span>
    
    <span class="nv">receive: </span><span class="nf">($xml, data) -&gt;</span>
       <span class="k">if</span> <span class="nx">$xml</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;setReadingSystemAttributesResult&quot;</span><span class="p">).</span><span class="nx">text</span><span class="p">()</span> <span class="o">is</span> <span class="s2">&quot;true&quot;</span>
         <span class="nx">eventSystemLogedOn</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">$xml</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;MemberId&quot;</span><span class="p">).</span><span class="nx">text</span><span class="p">()</span>  <span class="c1"># FIXME: Not a great function name - and it&#39;s spelled wrong</span>
       </pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>TODO: There's something weird going on here (read on)
If DODP.service.announcements is true (and announcements should be shown), then getServiceAnnouncements() is called
But getServiceAnnouncements' callback is responsible for setting DODP.service.announcements to true/false
So as far as I can tell, it's circular</p>             </td>             <td class="code">               <div class="highlight"><pre>         <span class="k">if</span> <span class="nx">DODP</span><span class="p">.</span><span class="nx">service</span><span class="p">.</span><span class="nx">announcements</span> <span class="o">and</span> <span class="kc">false</span> <span class="k">then</span> <span class="nx">rpc</span> <span class="s2">&quot;getServiceAnnouncements&quot;</span> <span class="c1"># FIXME: replace false with SHOW_SERVICE_ANNOUNCEMENTS</span>
       <span class="k">else</span>
         <span class="nx">alert</span> <span class="nx">aLang</span><span class="p">.</span><span class="nx">translate</span> <span class="s2">&quot;MESSAGE_LOGON_FAILED&quot;</span> <span class="c1"># FIXME: What the...? There&#39;s localization? Since when?</span>
  
  
  <span class="nv">getServiceAnnouncements:</span>
    <span class="nv">receive: </span><span class="nf">($xml, data) -&gt;</span>
      <span class="nx">$xml</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;announcements &gt; announcement&quot;</span><span class="p">).</span><span class="nx">each</span> <span class="o">-&gt;</span>
        <span class="nv">announcement = </span><span class="nx">jQuery</span> <span class="k">this</span>
        <span class="nx">alert</span> <span class="nx">announcement</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">).</span><span class="nx">text</span><span class="p">()</span>
        <span class="nx">rpc</span> <span class="s2">&quot;markAnnouncementsAsRead&quot;</span><span class="p">,</span> <span class="nx">announcement</span><span class="p">.</span><span class="nx">id</span>
  
  
  <span class="nv">markAnnouncementsAsRead:</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>TODO: Can you send an array or list of IDs instead? If you can, it would reduce the number of calls/requests</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">request: </span><span class="nf">(id) -&gt;</span>
      <span class="nv">read:</span>
        <span class="nv">item: </span><span class="nx">id</span>
    
  
  <span class="nv">getContentList:</span>
    <span class="nv">request: </span><span class="nf">(listID, firstItem, lastItem) -&gt;</span>
      <span class="nv">id: </span>       <span class="nx">listID</span>
      <span class="nv">firstItem: </span><span class="nx">firstItem</span>
      <span class="nv">lastItem: </span> <span class="nx">lastItem</span>
    
    <span class="nv">receive: </span><span class="nf">($xml, data) -&gt;</span>
      <span class="nx">eventSystemGotBookShelf</span> <span class="nx">data</span>
    
  
  <span class="nv">issueContent:</span>
    <span class="nv">request: </span><span class="nf">(bookID) -&gt;</span>
      <span class="nv">contentID: </span><span class="nx">bookID</span>
    
    <span class="nv">receive: </span><span class="nf">($xml) -&gt;</span>
      <span class="k">if</span> <span class="nx">$xml</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;issueContentResult&#39;</span><span class="p">).</span><span class="nx">text</span><span class="p">()</span> <span class="o">is</span> <span class="s2">&quot;true&quot;</span>
        <span class="nx">rpc</span> <span class="s2">&quot;getContentResources&quot;</span><span class="p">,</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">currentBook</span>
      <span class="k">else</span>
        <span class="nx">log</span><span class="p">.</span><span class="nx">error</span> <span class="s2">&quot;PRO: Error in issueContent parsing: #{$xml.find(&quot;</span><span class="nx">faultcode</span><span class="s2">&quot;).text()} - #{$xml.find(&#39;faultstring&#39;).text()}&quot;</span>
        <span class="nx">alert</span> <span class="s2">&quot;#{$xml.find(&quot;</span><span class="nx">faultcode</span><span class="s2">&quot;).text()} - #{$xml.find(&#39;faultstring&#39;).text()}&quot;</span>
      
    
  <span class="nv">returnContent:</span>
    <span class="nv">request: </span><span class="nf">(bookID) -&gt;</span>
      <span class="nv">contentId: </span><span class="nx">bookID</span>
    
    <span class="nv">receive: </span><span class="nf">($xml) -&gt;</span>
      <span class="k">if</span> <span class="nx">$xml</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;returnContentResult&quot;</span><span class="p">).</span><span class="nx">text</span><span class="p">()</span> <span class="o">is</span> <span class="s2">&quot;true&quot;</span>
        <span class="nx">rpc</span> <span class="s2">&quot;getBookShelf&quot;</span>
      <span class="k">else</span>
        <span class="nx">log</span><span class="p">.</span><span class="nx">error</span> <span class="s2">&quot;PRO: Error in returnContent parsing: #{$xml.find(&quot;</span><span class="nx">faultcode</span><span class="s2">&quot;).text()} - #{$xml.find(&#39;faultstring&#39;).text()}&quot;</span>
        <span class="nx">alert</span> <span class="s2">&quot;#{$xml.find(&quot;</span><span class="nx">faultcode</span><span class="s2">&quot;).text()} - #{$xml.find(&#39;faultstring&#39;).text()}&quot;</span>
      
  
  <span class="nv">getContentMetadata:</span>
    <span class="nv">request: </span><span class="nf">(bookID) -&gt;</span>
      <span class="nv">contentID: </span><span class="nx">bookID</span>
  
  
  
  <span class="nv">getContentResources:</span>
    <span class="nv">request: </span><span class="nf">(bookID) -&gt;</span>
      <span class="nv">contentID: </span><span class="nx">bookID</span>
    </pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>FIXME: Not fully implemented</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">receive: </span><span class="nf">($xml, data) -&gt;</span>
      <span class="nv">fault = </span><span class="nx">$xml</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;faultstring&#39;</span><span class="p">).</span><span class="nx">text</span><span class="p">()</span>
      <span class="k">if</span> <span class="nx">fault</span> <span class="o">isnt</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="nx">fault</span> <span class="o">is</span> <span class="s2">&quot;s:invalidParameterFault&quot;</span>
          <span class="nx">eventSystemEndLoading</span><span class="p">()</span>
        <span class="nx">log</span><span class="p">.</span><span class="nx">error</span> <span class="s2">&quot;PRO: Resource error: #{fault}&quot;</span>
        <span class="k">return</span>
          
        
      <span class="nx">$xml</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;resource&quot;</span><span class="p">).</span><span class="nx">each</span> <span class="o">-&gt;</span>
        <span class="nv">resource = </span><span class="nx">jQuery</span> <span class="k">this</span>
        <span class="nv">resourceURI = </span><span class="nx">resource</span><span class="p">.</span><span class="nx">attr</span> <span class="s2">&quot;uri&quot;</span>
        <span class="nv">components = </span><span class="nx">resourceURI</span><span class="p">.</span><span class="nx">match</span> <span class="sr">/^([^\/]+)\/\/([^\/]+)\/(.*)$/</span>
        
        <span class="nv">url = </span><span class="s2">&quot;#{components[1]}//#{window.location.hostame}/#{components[3]}&quot;</span>
        <span class="k">if</span> <span class="nx">resourceURI</span><span class="p">.</span><span class="nx">match</span> <span class="sr">/ncc.htm$/i</span> <span class="k">then</span> <span class="nv">nccPath = </span><span class="nx">url</span>
        </pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>FIXME: Not fully implemented</p>             </td>             <td class="code">               <div class="highlight"><pre>  
  
  <span class="nv">setBookmarks:</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>FIXME: Not fully implemented</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">request: </span><span class="nf">(bookID, bookmarkData) -&gt;</span>
      <span class="nv">contentID: </span><span class="nx">bookID</span>
      <span class="nv">bookmarkSet:</span>
        <span class="nv">title:</span>
          <span class="nv">text: </span><span class="nx">bookID</span>
          <span class="nv">audio: </span><span class="s2">&quot;&quot;</span>
        <span class="nv">uid: </span><span class="nx">bookID</span>
        <span class="nv">lastmark:</span>
          <span class="nv">ncxref: </span>    <span class="s2">&quot;xyub00066&quot;</span>
          <span class="nv">URI: </span>       <span class="s2">&quot;cddw000A.smil#xyub00066&quot;</span>
          <span class="nv">timeOffset: </span><span class="s2">&quot;00:10.0&quot;</span>
        
      
    
  


  

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 